<!DOCTYPE html>
<html>
    <head>
        <title>Not So Simple</title>
        
        <link rel="icon", href="images/seed.png"></link>
        <link rel="stylesheet", href="view/nss.css"></link>
    </head>
    <body>
        <div id="main-div">
            <canvas id="canv", width=1280, height=720></canvas>
            <!-- <canvas id="canv", width=960, height=540></canvas> -->
            <!-- <canvas id="canv", width=640, height=360></canvas> -->
        </div>
        
        <script src="events.js"></script>
        <script src="Vector.js"></script>
        <script src="Rectangle.js"></script>
        <script src="draft.js"></script>
        
        <script src="Entity.js"></script>
        <script src="Action.js"></script>
        <script src="interactions/Interaction.js"></script>
        <script src="Battler.js"></script>
        
        <script src="actions/draft-actions.js"></script>
        <script src="actions/cursorControl.js"></script>
        <script src="actions/Jump.js"></script>
        <script src="actions/Teleport.js"></script>
        <script src="actions/ProjectileShot.js"></script>
        <script src="actions/Movement.js"></script>
        <script src="actions/cutter.js"></script>
        <script src="actions/lcreate.js"></script>
        <script src="actions/sword.js"></script>
        <script src="actions/zyxei.js"></script>
        
        <script src="entities/draft-entities.js"></script>
        <script src="entities/Camera.js"></script>
        <script src="entities/PlayableCharacter.js"></script>
        <script src="entities/Adnyropast.js"></script>
        <script src="entities/Haple.js"></script>
        <script src="entities/Ten.js"></script>
        
        <script id="canvas", src="canvas.js"></script>
        
        <script src="images.js"></script>
        
        <script id="entitycollections">
        
        class EntityCollection extends Array {
            add(entity) {
                if(this.indexOf(entity) == -1) {
                    this.push(entity);
                }
                
                return this;
            }
            
            remove(entity) {
                var index = this.indexOf(entity);
                
                if(index != -1) {
                    this.splice(index, 1);
                }
                
                return this;
            }
            
            clear() {
                this.splice(0, this.length);
                
                return this;
            }
        }
        
        const NOENTITY = [];
        const ENTITIES = new EntityCollection();
        const COLLIDABLE = new EntityCollection();
        const DRAWABLE = new EntityCollection();
        const PLAYABLE = new EntityCollection();
        var CAMERA = TCamera.fromMiddle([BASEWIDTH / 2, BASEHEIGHT / 2], [640, 360]);
        var PLAYER = null;
        
        function addEntity(entity) {
            ENTITIES.add(entity);
            
            if(entity.isCollidable()) {
                COLLIDABLE.add(entity);
            }
            
            if(entity.isDrawable()) {
                DRAWABLE.add(entity);
            }
            
            if(entity instanceof PlayableCharacter) {
                PLAYABLE.add(entity);
                PLAYER = entity;
            }
            
            if(entity instanceof TCamera) {
                CAMERA = entity;
            }
        }
        
        function addEntities(entities) {
            for(var i = 0; i < entities.length; ++i) {
                addEntity(entities[i]);
            }
        }
        
        function removeEntity(entity) {
            entity.onremove();
            
            ENTITIES.remove(entity);
            COLLIDABLE.remove(entity);
            DRAWABLE.remove(entity);
            PLAYABLE.remove(entity);
            
            if(entity == PLAYER) {
                PLAYER = null;
            }
        }
        
        function clearEntities() {
            ENTITIES.clear();
            COLLIDABLE.clear();
            DRAWABLE.clear();
            PLAYABLE.clear();
        }
        
        </script>
        <script>
        
        window.addEventListener("keydown", function(event) {
            if(PLAYER != null) {
                if(K_FOCUS.includes(event.keyCode)) {
                    PLAYER.addAction(new HoldFocus());
                }
                
                if([80].includes(event.keyCode)) {
                    PLAYER.addAction(new ProjectileShot());
                }
            }
        });
        
        window.addEventListener("keyup", function(event) {
            if(PLAYER != null) {
                if(K_FOCUS.includes(event.keyCode)) {
                    PLAYER.removeActionsWithConstructor(HoldFocus);
                } if([16].includes(event.keyCode)) {
                    PLAYER.removeActionsWithConstructor(Still);
                } if(K_FLURRY.includes(event.keyCode)) {
                    PLAYER.removeActionsWithConstructor(ZyxeiFlurry);
                } if(K_DIRECTION.includes(event.keyCode)) {
                    PLAYER.removeActionsWithConstructor(Movement);
                } if(K_JUMP.includes(event.keyCode)) {
                    PLAYER.removeActionsWithConstructor(Jump);
                }
            }
        });
        
        window.addEventListener("mousemove", function(event) {
            if(PLAYER != null) {
                PLAYER.addAction(new MouseFocus());
            }
        });
        
        window.addEventListener("mousedown", function(event) {
            if(PLAYER != null) {
                if(event.which == 1) {
                    <!-- PLAYER.addAction(new OverheadSlash()); -->
                    PLAYER.addAction(new RocketPunch());
                    <!-- player.addAction(new CutterBoomerang()); -->
                    <!-- player.addAction(new CutterDash()); -->
                    // this.addAction(new TargetAttack(this.cursor.getPositionM()));
                }
            }
        });
        
        window.addEventListener("mouseup", function(event) {
            if(PLAYER != null) {
                if(event.which == 1) {
                    PLAYER.removeActionsWithConstructor(OverheadSlash);
                }
            }
        });
        
        function playerUpdate(player) {
            if(keyList.value(27)) {
                player.actions = [];
            }
            
            if(keyList.value(107)) {
                ++this.cursorDistance;
            } if(keyList.value(109)) {
                --this.cursorDistance;
            }
            
            /**
            if(keyList.value(K_FOCUS)) {
                player.addAction(new HoldFocus());
            } else {
                player.removeActionsWithConstructor(HoldFocus);
            }
            /**/
            if(keyList.value(K_PRESSFOCUS) == 1) {
                player.addAction(new PressFocus());
            }
            
            if(keyList.value(K_CDIRECTION)) {
                player.addAction(new FreeKeyFocus());
            }
            
            if(keyList.value(71)) {
                player.addAction(new RoundFocus(8));
            }
            
            if(keyList.value(16)) {
                player.addAction(new Still());
            }
            
            if(keyList.value(K_FLURRY)) {
                player.addAction(new ZyxeiFlurry());
            }
            
            if(keyList.value(K_DIRECTION)) {
                player.route = getKDirection().add(player.getPositionM());
                player.addAction(new MoveFocus());
                player.addAction(new Movement());
            }
            
            if(keyList.value(K_JUMP)) {
                // player.drag(Vector.from(player.gravityDirection).normalize(-16));
                player.addAction(new Jump());
            }
            
            if(keyList.value(67) == 1) {
                if(CAMERA.target == player) {
                    CAMERA.target = null;
                } else {
                    CAMERA.target = player;
                }
            }
            
            if(keyList.value(67)) {
                player.addAction(new LCreation());
            } else {
                player.removeActionsWithConstructor(LCreation);
            }
            
            if(keyList.value(84) == 1) {
                player.addAction(new Teleportation(player.cursor.getPositionM(), 20, 20));
            }
            
            if(keyList.value(66) == 1) {
                player.addAction(new BlowoutShots(player.cursor.getPositionM()));
            }
            
            if(keyList.value(77) == 1) {
                player.addAction(new MultiaimShots());
            } else {
                player.removeActionsWithConstructor(MultiaimShots);
            }
            
            if(keyList.value(69)) {
                player.addAction(new ZoneEngage());
            }
        }
        
        var timenote = document.createElement("text");
        document.body.appendChild(timenote);
        var lastDate = new Date();
        
        function worldLoop() {
            playerUpdate(PLAYER);
            
            for(var i = 0; i < ENTITIES.length; ++i) {
            <!-- for(var i = ENTITIES.length - 1; i >= 0; --i) { -->
                var entity = ENTITIES[i];
                
                entity.update();
                
                if(entity.isRemovable()) {
                    removeEntity(entity);
                }
            }
            
            for(var i = 0; i < ENTITIES.length; ++i) {
                var entity = ENTITIES[i];
                entity.updateReset();
            }
            
            keyList.increment();
            mouse.increment();
            
            for(var i = 0; i < COLLIDABLE.length; ++i) {
                for(var j = i + 1; j < COLLIDABLE.length; ++j) {
                    if(COLLIDABLE[i].collides(COLLIDABLE[j])) {
                        COLLIDABLE[i].oncollision(COLLIDABLE[j]);
                        COLLIDABLE[j].oncollision(COLLIDABLE[i]);
                    }
                }
            }
            
            var context = CANVAS.getContext("2d");
            
            /** DRAWING UPDATE **
            
            context.fillStyle = "#FFFFFF3F";
            context.fillRect(0, 0, CANVAS.width, CANVAS.height);
            context.clearRect(0, 0, CANVAS.width, CANVAS.height);
            
            /**/
            
            DRAWABLE.sort(function(a, b) {
                if(a.getZIndex() > b.getZIndex()) {
                    return -1;
                } if(a.getZIndex() < b.getZIndex()) {
                    return +1;
                }
                
                return 0;
            });
            
            for(var i = 0; i < DRAWABLE.length; ++i) {
                /**
                if(i < DRAWABLE.length - 1 && DRAWABLE[i].getZIndex() < DRAWABLE[i + 1].getZIndex()) {
                    var drawable = DRAWABLE[i + 1];
                    DRAWABLE[i + 1] = DRAWABLE[i];
                    DRAWABLE[i] = drawable;
                }
                /**/
                var drawable = DRAWABLE[i];
                
                var x = drawable.getX();
                var y = drawable.getY();
                var width = drawable.getWidth();
                var height = drawable.getHeight();
                
                var wprop = CANVAS.width / CAMERA.width;// BASEWIDTH;
                var hprop = CANVAS.height / CAMERA.height;// BASEHEIGHT;
                
                x += -CAMERA.getOffsetX();
                y += -CAMERA.getOffsetY();
                
                x *= wprop;
                y *= hprop;
                width *= wprop;
                height *= hprop;
                
                if(x == -Infinity) {
                    x = 0;
                } if(y == -Infinity) {
                    y = 0;
                } if(width == Infinity) {
                    width = CANVAS.width;
                } if(height == Infinity) {
                    height = CANVAS.height;
                }
                
                var style = drawable.getStyle();
                
                if(style instanceof HTMLImageElement) {
                    context.drawImage(style, x, y, width, height);
                } else {
                    context.fillStyle = style;
                    // context.fillRect(x, y, width, height);
                    context.translate(x, y);
                    context.fillRect(0, 0, width, height);
                    context.translate(-x, -y);
                }
            }
            
            if(PLAYER) {
                context.fillStyle = "#EFEFEF";
                context.fillText("Energy : " + PLAYER.energy, 0, 0);
                context.fillStyle = "rgba(255, " + (255 * PLAYER.getEnergyRatio()) + ", 0)";
                context.fillText(PLAYER.energy, 66.75 * CANVAS.height / BASEHEIGHT, 0);
                <!-- context.fillText(PLAYER.energy, 0, 16); -->
                <!-- context.fillText(PLAYER.energy, 0, 32); -->
                <!-- context.fillText(PLAYER.energy, 0, 48); -->
                <!-- context.fillText(PLAYER.energy, 0, 64); -->
            } else {
                mapTest();
            }
            
            <!-- timenote.innerHTML = new Date() - lastDate; -->
            <!-- lastDate = new Date(); -->
        }
        
        const BATTLERS = new EntityCollection();
        const SKILLS = new EntityCollection();
        
        var battleturn = 0;
        var actorIndex = 0;
        
        function addBattler(battler) {
            if(battler instanceof Entity && battler.isBattler()) {
                BATTLERS.add(Battler.fromEntity(battler));
            }
        }
        
        function addBattlers(battlers) {
            for(var i = 0; i < battlers.length; ++i) {
                addBattler(battlers[i]);
            }
        }
        
        function addSkill(skill) {
            SKILLS.add(skill);
        }
        
        function removeSkill(skill) {
            SKILLS.remove(skill);
        }
        
        /**
        
        BATTLERS.sort(function(a, b) {
            if(a.getPriority() > b.getPriority) return -1;
            if(a.getPriority() < b.getPriority) return +1;
            return 0;
        });
        
        /**/
        
        function battlePreparingLoop() {
            for(var i = 0; i < BATTLERS.length; ++i) {
                var battler = BATTLERS[i];
                
                if(!battler.isReady()) {
                    return;
                }
            }
            
            switchLoop(battleActingLoop, WORLD_PACE);
        }
        
        function battleActingLoop() {
            SKILLS.sort(function() {
                return 0;
            });
            
            SKILLS[0].use();
        }
        
        function endofturn() {
            ++actorIndex;
            actorIndex %= BATTLERS.length;
        }
        
        var gameInterval;
        var gameLoop = worldLoop;
        
        function switchLoop(loopF, pace) {
            gameLoop = loopF;
            clearInterval(gameInterval);
            gameInterval = setInterval(loopF, pace);
        }
        
        function repaceLoop(pace) {
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, pace);
        }
        
        function loadCheck(nextLoop, nextPace) {
            if(loadCounter == 0) {
                for(var i = 0; i < IMGS.length; ++i) {
                    if(!IMGS[i].complete || IMGS[i].naturalWidth === 0) {
                        return;
                    }
                }
                
                mapTest();
                switchLoop(nextLoop, nextPace);
            }
        }
        
        function engageBattle(battlers = NOENTITY) {
            addBattlers(battlers);
            switchLoop(battlePreparingLoop, WORLD_PACE);
        }
        
        switchLoop(loadCheck.bind(this, gameLoop, WORLD_PACE), 16);
        
        </script>
        <script src="draft-maps.js"></script>
    </body>
</html>